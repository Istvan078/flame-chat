<div class="messages-page">
  <!-- Header / App bar -->
  <mat-toolbar color="primary" class="appbar" role="heading" aria-level="1">
    <button
      mat-icon-button
      (click)="openMainMenu?.()"
      aria-label="Menü megnyitása"
    >
      <mat-icon>menu</mat-icon>
    </button>

    <span class="title">Üzenetek</span>

    <span class="spacer"></span>

    <button
      mat-icon-button
      (click)="openNotifications?.()"
      aria-label="Értesítések"
    >
      <mat-icon
        [ngClass]="haventSeenMessagesArr?.length ? 'text-primary' : ''"
        [matBadge]="haventSeenMessagesArr?.length"
        [matBadgeColor]="haventSeenMessagesArr?.length ? 'warn' : 'primary'"
        >notifications</mat-icon
      >
    </button>

    <button mat-icon-button (click)="openProfile?.()" aria-label="Profil">
      <mat-icon>account_circle</mat-icon>
    </button>
  </mat-toolbar>

  <!-- Top actions (Új üzenet / Archív) -->
  <div class="text-center mb-0 mt-2 mess-search-cont">
    <mat-form-field appearance="outline" class="friend-search-field">
      <mat-label>Keresés</mat-label>
      <input
        (keyup)="searchMessage()"
        matInput
        [(ngModel)]="friendSearch"
        placeholder="Ismerős neve"
      />
      <button
        *ngIf="friendSearch"
        matSuffix
        mat-icon-button
        (click)="friendSearch = ''; searchMessage()"
        aria-label="Keresőmező törlése"
      >
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>
  </div>
  <div class="top-actions">
    <button
      mat-button
      class="top-action"
      (click)="showFriendsToChoose = !showFriendsToChoose"
    >
      <mat-icon>note_add</mat-icon>
      <span>Új üzenet</span>
    </button>

    <!-- <button mat-button class="top-action"> -->
    <!-- <mat-icon>search</mat-icon>
      <span>Kereses</span> -->

    <!-- </button> -->

    <!-- <button
      mat-button
      class="top-action"
      (click)="showAllFriends = !showAllFriends"
    >
      <mat-icon>group</mat-icon>
      <span>Új üzenet</span>
    </button> -->

    <!-- <button mat-button class="top-action" (click)="toArchivedMsgs()">
      <mat-icon>archive</mat-icon>
      <span>Archivált üzenetek</span>
    </button> -->
  </div>

  <!-- Friend search reveal -->
  <section *ngIf="showFriendsToChoose" class="friend-search">
    <mat-form-field appearance="outline" class="friend-search-field">
      <mat-label>Keresés ismerősre</mat-label>
      <input matInput [(ngModel)]="friendSearch" placeholder="Ismerős neve" />
      <button
        *ngIf="friendSearch"
        matSuffix
        mat-icon-button
        (click)="friendSearch = ''"
        aria-label="Keresőmező törlése"
      >
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>

    <div *ngFor="let friend of showFriendsMess | filter : friendSearch">
      <div *ngIf="friendSearch && !friend.messaging" class="search-result-item">
        <img
          [src]="friend.profilePicture"
          [alt]="friend.displayName + ' profilképe'"
          class="avatar-small"
        />
        <span class="friend-name">{{ friend.displayName }}</span>
        <button
          mat-stroked-button
          color="primary"
          class="start-chat-btn"
          (click)="firstMessageToFriend(friend)"
        >
          <mat-icon class="align-middle">message</mat-icon>
          Üzenet írása
        </button>
      </div>
    </div>
  </section>

  <!-- All friends list (expand) -->
  <section *ngIf="showAllFriends" class="show-all-friends">
    <div *ngFor="let friend of showFriendsMess" class="friend-tile">
      <img
        [src]="friend.profilePicture"
        [alt]="friend.displayName + ' profilképe'"
        class="avatar-small"
      />
      <div class="name">{{ friend.displayName }}</div>
      <button
        mat-raised-button
        color="primary"
        (click)="firstMessageToFriend(friend); showAllFriends = false"
      >
        Új üzenet
      </button>
    </div>
  </section>

  <!-- Archived toggle mirror (only if there are archived) -->
  <section
    *ngIf="archivedFriends?.length && isShowArchMsgs"
    class="archived-controls"
  >
    <button mat-stroked-button color="primary" (click)="backToMsgs()">
      <mat-icon>message</mat-icon>
      Üzenetek
    </button>
  </section>

  <!-- Conversation list -->
  <section class="chat-list" *ngIf="!isShowArchMsgs">
    <ng-container *ngFor="let friend of showFriendsMess; let i = index">
      <ng-container *ngIf="friend.messaging || friend.seen === false">
        <mat-card class="conversation-card" (click)="getMessageUser(friend)">
          <div class="left">
            <div class="avatar-container">
              <img
                [src]="friend.profilePicture"
                [alt]="friend.displayName + ' profilképe'"
                class="avatar"
              />
              <span
                *ngIf="friend.online && friend.visibility"
                class="online-dot"
              ></span>
            </div>
          </div>

          <div class="center">
            <div class="name">{{ friend.displayName }}</div>
            <div class="last-msg" [class.unread]="friend.newMessageNumber">
              <ng-container *ngIf="lastMsgsWithFriends">
                <ng-container *ngFor="let lastMsgWithFr of lastMsgsWithFriends">
                  <span
                    *ngIf="
                      lastMsgWithFr?.message.senderId === friend.friendId ||
                      lastMsgWithFr?.participants[1] === friend.friendId
                    "
                  >
                    {{
                      lastMsgWithFr?.replyMessage
                        ? lastMsgWithFr.replyMessage.message
                        : lastMsgWithFr?.message.message
                    }}
                  </span>
                </ng-container>
              </ng-container>
            </div>
            <!-- <div
              class="last-seen"
              *ngIf="
                !friend.newMessageNumber && friend.visibility && !friend.online
              "
            >
              Utoljára elérhető: {{ friend.lastTimeOnline }}
            </div> -->
          </div>

          <div class="right">
            <button
              mat-icon-button
              [matMenuTriggerFor]="menu"
              (click)="$event.stopPropagation()"
              aria-label="Műveletek"
            >
              <mat-icon>more_vert</mat-icon>
            </button>
            <div *ngIf="friend.newMessageNumber" class="unread-badge">
              {{ friend.newMessageNumber }}
            </div>
          </div>
        </mat-card>

        <mat-menu #menu="matMenu">
          <button
            mat-menu-item
            (click)="archiveFriend(friend, userProfile.key, i)"
          >
            <mat-icon>archive</mat-icon>
            <span>Archíválás</span>
          </button>
          <button
            mat-menu-item
            (click)="deleteAllMsgsWithFriend(friend.friendKey)"
          >
            <mat-icon>delete</mat-icon>
            <span>Törlés</span>
          </button>
        </mat-menu>
      </ng-container>
    </ng-container>

    <div *ngIf="showFriendsMess?.length === 0" class="no-friends-msg">
      Válassz ki egy ismerőst új üzenet írásához!
    </div>
  </section>

  <!-- Archived list -->
  <app-archived-messages
    *ngIf="isShowArchMsgs"
    [archivedFriendsMess]="archivedFriends"
    [lastMsgsWithFriends]="lastMsgsWithFriends"
    [userProfile]="userProfile"
    (toFriendsMessage)="getMessageUser($event)"
    (cancelArchiFriend)="cancelArcFriend($event)"
  >
  </app-archived-messages>

  <!-- Bottom navigation -->
  <nav class="bottom-nav">
    <button class="nav-item active" (click)="backToMsgs()">
      <mat-icon>chat_bubble_outline</mat-icon>
      <span>Üzenetek</span>
    </button>
    <button class="nav-item" (click)="backToMainPage()">
      <mat-icon>home</mat-icon>
      <span>Főoldal</span>
    </button>
    <button class="nav-item" (click)="openMainMenu?.()">
      <mat-icon>menu</mat-icon>
      <span>Menü</span>
    </button>
  </nav>
</div>
