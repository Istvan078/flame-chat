<div [@slide-in-keyframed]="chatAnimationState" class="chat-container">
  <div class="header-actions">
    <button routerLink="/chat" class="green back-button" type="button" mat-raised-button>
      <mat-icon>keyboard_backspace</mat-icon>
      Vissza a főoldalra
    </button>
    
    <div class="new-message-actions">
      <button (click)="showFriendsToChoose = !showFriendsToChoose" class="btn btn-primary new-message-btn" type="button">
        <mat-icon class="align-middle">message</mat-icon>
        Új üzenet (ismerős keresése)
      </button>

      <button (click)="showAllFriends = !showAllFriends" class="btn btn-success new-message-btn" type="button">
        <mat-icon class="align-middle">message</mat-icon>
        Új üzenet (összes ismerős)
      </button>
    </div>
  </div>

  <!-- Ismerős keresés -->
  <div class="friend-search-container" *ngIf="showFriendsToChoose">
    <input [(ngModel)]="friendSearch" placeholder="Ismerős neve" class="form-control search-input" type="text" />
    <div class="search-results">
      <ng-container *ngFor="let mess of showFriendsMess | filter : friendSearch">
        <div class="friend-card" *ngIf="!mess.messaging && friendSearch">
          <img class="profile-picture" [src]="mess.profilePicture" alt="" />
          <div class="friend-info">
            <h3>{{ mess.displayName }}</h3>
            <button (click)="firstMessageToFriend(mess)" class="btn btn-success message-btn">
              <span>Üzenet írása</span>
              <mat-icon class="align-middle">message</mat-icon>
            </button>
          </div>
        </div>
      </ng-container>
    </div>
  </div>

  <!-- Összes ismerős -->
  <div class="all-friends-container" *ngIf="showAllFriends">
    <div class="friends-grid">
      @for(mess of showFriendsMess; track mess.friendId) {
        <div class="friend-card" *ngIf="!mess.messaging">
          <img class="profile-picture" [src]="mess.profilePicture" alt="" />
          <div class="friend-info">
            <h3>{{ mess.displayName }}</h3>
            <button (click)="firstMessageToFriend(mess); showAllFriends = !showAllFriends" class="btn btn-success message-btn">
              Új üzenet
            </button>
          </div>
        </div>
      }
    </div>
  </div>

  <!-- Aktív beszélgetések -->
  <div class="active-chats">
    @for(mess of showFriendsMess; track mess.friendId) {
      <div class="chat-card" *ngIf="mess.messaging || mess.seen === false">
        <div class="new-message-indicator" *ngIf="mess.newMessageNumber">
          <h3>Új üzenet érkezett</h3>
        </div>
        
        <div #messageCardCont class="card message-card" [ngClass]="mess.newMessageNumber ? 'newMessageColorOnCard' : 'messageCardBg'">
          <div class="card-body">
            <div class="user-info">
              <img [src]="mess.profilePicture" class="profile-picture" />
              <h2>{{ mess.displayName }}</h2>
            </div>

            <div class="last-message">
              <ng-container *ngFor="let lastMsgWithFr of lastMsgsWithFriends">
                <p *ngIf="lastMsgWithFr?.message.senderId === mess.friendId || lastMsgWithFr?.participants[1] === mess.friendId">
                  {{ lastMsgWithFr?.replyMessage ? lastMsgWithFr?.replyMessage.message : lastMsgWithFr?.message.message }}
                </p>
              </ng-container>
            </div>

            <div class="status-container">
              <div class="online-status" *ngIf="mess.online && mess.visibility">
                <div class="online-dot-container">
                  <div class="online-dot"></div>
                  <div class="online-text">Elérhető</div>
                </div>
              </div>
              
              <div class="last-seen" *ngIf="!mess.online && !mess.newMessageNumber && mess.visibility">
                <p class="last-seen-label">Utoljára elérhető:</p>
                <p class="last-seen-time">{{ mess.lastTimeOnline }}</p>
              </div>
            </div>
          </div>

          <div class="card-footer">
            <button (click)="getMessageUser(mess)" mat-raised-button class="btn blue msg-button" type="button">
              Üzenetek
              <mat-icon>chat</mat-icon>
            </button>
          </div>
        </div>
      </div>
    } @empty {
      <div class="empty-state">
        <mat-icon class="empty-icon">message</mat-icon>
        <p>Válassz ki egy ismerőst új üzenet írásához!</p>
      </div>
    }
  </div>
</div>
