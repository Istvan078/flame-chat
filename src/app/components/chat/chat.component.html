<div class="home-page test">
  <!-- App bar / Header -->
  <mat-toolbar class="appbar">
    <!-- <button mat-icon-button (click)="openMainMenu?.()" aria-label="Menü">
      <mat-icon>menu</mat-icon>
    </button> -->

    <span class="title">
      <mat-icon class="fire">local_fire_department</mat-icon>
      Flame Chat
    </span>
    <span class="spacer"></span>

    <mat-slide-toggle
      #slideToggle
      (click)="
        updateUserNotifications({ checked: !subscribedForNotifications })
      "
      [checked]="subscribedForNotifications"
    ></mat-slide-toggle>
    <button mat-icon-button aria-label="Értesítések">
      <mat-icon>{{
        slideToggle.checked ? 'notifications_active' : 'notifications_none'
      }}</mat-icon>
    </button>

    <button mat-icon-button (click)="openProfileOptions()" aria-label="Profil">
      <!-- <mat-icon class="account-settings">account_circle</mat-icon> -->
      <img
        [src]="userProfile.profilePicture"
        alt="Profilkép"
        class="rounded-circle"
        width="50px"
        height="50px"
      />
    </button>
  </mat-toolbar>

  <!-- Kereső szekció -->
  <section class="search-section">
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>{{ 'mainPage.searchUser' | translate }}</mat-label>
      <input
        matInput
        [(ngModel)]="userSearched"
        (keyup)="searchUser()"
        placeholder="{{ 'mainPage.searchByName' | translate }}"
      />
      <button
        *ngIf="userSearched"
        matSuffix
        mat-icon-button
        aria-label="Törlés"
        (click)="userSearched = ''; searchUser()"
      >
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>

    <!-- találatok -->
    <div *ngFor="let user of userSearchedProfiles" class="search-result">
      <button class="result-left" (click)="toFriendProfile(user.uid)">
        <img [src]="user.profilePicture" alt="profilkép" class="avatar" />
        <div class="name">{{ user.displayName }}</div>
      </button>
      <ng-container *ngFor="let notFriend of userNotFriends">
        <button
          *ngIf="notFriend.friendId === user.uid"
          mat-raised-button
          color="accent"
          class="add-btn"
          (click)="signAsAFriend(notFriend)"
        >
          <mat-icon>person_add</mat-icon>
          {{ 'user.signAsFriend' | translate }}
        </button>
      </ng-container>
    </div>
  </section>

  <section
    class="suggestions suggestions--compact"
    *ngIf="userNotFriends.length"
  >
    <div class="sugg-head">
      <h3>{{ 'user.suggestedFriends' | translate }}</h3>
    </div>

    <div class="sugg-viewport" #suggViewport (scroll)="updateSuggNav()">
      <!-- bal/jobb nyilak overlay a soron -->
      <button
        class="nav prev"
        mat-mini-fab
        (click)="scrollSugg('left')"
        [disabled]="!canScrollLeft"
        aria-label="Balra"
      >
        <mat-icon>chevron_left</mat-icon>
      </button>
      <button
        class="nav next"
        mat-mini-fab
        (click)="scrollSugg('right')"
        [disabled]="!canScrollRight"
        aria-label="Jobbra"
      >
        <mat-icon>chevron_right</mat-icon>
      </button>

      <div class="sugg-track">
        <ng-container *ngFor="let nf of userNotFriends; trackBy: trackByUid">
          <div
            class="sugg-card"
            *ngIf="
              !userProfile.blockedPeople?.includes(nf.friendId) &&
              !nf?.blockedFromApp
            "
          >
            <img
              class="avatar"
              [src]="nf.profilePicture"
              alt="{{ nf.displayName }} profilképe"
              loading="lazy"
              (click)="toPersonProfile(nf)"
            />
            <div class="name" [title]="nf.displayName">
              {{ nf.displayName }}
            </div>
            <button
              class="add"
              mat-stroked-button
              color="primary"
              (click)="signAsAFriend(nf)"
            >
              <mat-icon>person_add</mat-icon
              ><span>{{ 'user.signAsFriend' | translate }}</span>
            </button>
          </div>
        </ng-container>
      </div>
    </div>
  </section>

  <!-- Menücsempék / gyors műveletek -->
  <section class="menu-grid">
    <!-- Saját posztok -->
    <button
      class="menu-card"
      routerLink="/my-posts"
      (click)="
        getMyPosts();
        isMyPostsOpen = true;
        isFeedOpen = false;
        isFriendsOpen = false;
        isUserProfileOn = false;
        scrollToContentArea()
      "
    >
      <div class="icon-wrap">
        <img
          [src]="userProfile.profilePicture"
          alt="Profilkép"
          class="mini-avatar"
        />
      </div>
      <div class="text">
        <div class="label">{{ userProfile.displayName || 'Profilom' }}</div>
        <div class="sub">{{ 'mainPage.myFeeds' | translate }}</div>
      </div>
      <mat-icon
        [matBadgeDisabled]="!myPostsNotificationNumber"
        [matBadge]="myPostsNotificationNumber"
        matBadgeColor="primary"
        >article</mat-icon
      >
    </button>

    <!-- Kezdőlap / Feed -->
    <button
      class="menu-card"
      routerLink="/feeds"
      (click)="
        getSharedPosts();
        isFeedOpen = true;
        isMyPostsOpen = false;
        isFriendsOpen = false;
        isUserProfileOn = false;
        scrollToContentArea()
      "
    >
      <div class="icon-wrap">
        <mat-icon>feed</mat-icon>
      </div>
      <div class="text">
        <div class="label">{{ 'mainPage.feeds' | translate }}</div>
        <div class="sub">{{ 'mainPage.publicPosts' | translate }}</div>
      </div>
      <mat-icon
        [matBadgeDisabled]="!postsNotificationNumber"
        [matBadge]="postsNotificationNumber"
        matBadgeColor="primary"
        >notifications</mat-icon
      >
    </button>

    <!-- Üzenetek -->
    <button class="menu-card" routerLink="/message">
      <div class="icon-wrap">
        <mat-icon>chat</mat-icon>
      </div>
      <div class="text">
        <div class="label">{{ 'mainPage.messages' | translate }}</div>
        <div class="sub">{{ 'mainPage.yourConvs' | translate }}</div>
      </div>
      <mat-icon
        [matBadgeDisabled]="!newMessageNumber"
        [matBadge]="newMessageNumber"
        matBadgeColor="primary"
        >mark_chat_unread</mat-icon
      >
    </button>

    <!-- Fényképeim -->
    <button
      class="menu-card"
      (click)="
        toAlbum();
        isMyPostsOpen = false;
        isFeedOpen = false;
        isFriendsOpen = false;
        isUserProfileOn = false
      "
    >
      <div class="icon-wrap">
        <mat-icon>photos</mat-icon>
      </div>
      <div class="text">
        <div class="label">{{ 'mainPage.albums' | translate }}</div>
        <!-- <div class="sub">Albumok és képek</div> -->
      </div>
      <mat-icon>chevron_right</mat-icon>
    </button>

    <!-- Ismerősök -->
    <button
      class="menu-card"
      (click)="
        isFriendsOpen = true;
        isFeedOpen = false;
        isMyPostsOpen = false;
        isUserProfileOn = false;
        scrollToContentArea()
      "
    >
      <div class="icon-wrap">
        <mat-icon>groups</mat-icon>
      </div>
      <div class="text">
        <div class="label">{{ 'mainPage.friends' | translate }}</div>
        <div class="sub">{{ 'mainPage.yourFriends' | translate }}</div>
      </div>
      <mat-icon
        [matBadgeDisabled]="!userFriends?.length"
        [matBadge]="userFriends?.length"
        matBadgeColor="primary"
        >diversity_3</mat-icon
      >
    </button>

    <!-- Profilom -->
    <button
      class="menu-card"
      (click)="
        toUserProfile();
        isUserProfileOn = true;
        isFeedOpen = false;
        isMyPostsOpen = false;
        isFriendsOpen = false
      "
    >
      <div class="icon-wrap">
        <mat-icon>person</mat-icon>
      </div>
      <div class="text">
        <div class="label">{{ 'mainPage.profile' | translate }}</div>
        <div class="sub">{{ 'mainPage.profAndSett' | translate }}</div>
      </div>
      <mat-icon>chevron_right</mat-icon>
    </button>
  </section>

  <!-- Tartalmi szekciók (panelek helyett) -->
  <section class="content scroll-to-content" *ngIf="isMyPostsOpen">
    <app-my-posts></app-my-posts>
  </section>

  <section class="content scroll-to-content" *ngIf="isFeedOpen">
    <app-news [userFriends]="this.userFriends"></app-news>
  </section>

  <section class="content scroll-to-content" *ngIf="isFriendsOpen">
    <div class="friends-grid">
      @for(friend of userFriends; let i = $index; track friend.displayName){
      @defer(on viewport){
      <mat-card class="friend-card">
        <img
          [src]="friend.profilePicture"
          width="56"
          height="56"
          class="avatar"
          alt=""
          (click)="showProfPics(friend)"
        />
        <div class="fname">{{ friend.displayName }}</div>
        <div class="femail">{{ friend.email }}</div>
        <div class="actions">
          <button
            mat-stroked-button
            color="primary"
            (click)="toFriendProfile(friend.friendId)"
          >
            <mat-icon>person</mat-icon>
            Profil
          </button>
          <button
            mat-stroked-button
            color="warn"
            (click)="removeFriend(friend)"
          >
            <mat-icon>person_remove</mat-icon>
            Törlés
          </button>
        </div>
      </mat-card>
      } @placeholder{
      <p>Ismerosok listaja toltodik...</p>
      } }
    </div>
  </section>

  <section class="content" *ngIf="isUserProfileOn && userProfile.uid">
    <app-user-profile></app-user-profile>
  </section>

  <!-- Alsó navigáció (a chatlistével egységes) -->
  <nav class="bottom-nav">
    <button class="nav-item" routerLink="/message">
      <mat-icon>chat_bubble_outline</mat-icon>
      <span>Üzenetek</span>
    </button>
    <button class="nav-item active">
      <mat-icon>home</mat-icon>
      <span>Főoldal</span>
    </button>
    <button class="nav-item" (click)="openMainMenu()">
      <mat-icon>menu</mat-icon>
      <span>Menü</span>
    </button>
  </nav>
</div>
