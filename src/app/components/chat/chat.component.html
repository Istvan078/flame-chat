<h1 class="text-center">Flame Chat</h1>

<!-- <div *ngFor="let friend of userProfile[0].friends">
  
    <h2>Teszt</h2>
    <h3></h3>
    
    <button (click)="getMessageById(userProfile[0]['key'], friend['key'], '')" type="button">Barat adatainak lekerese</button>
    
    
    <input [(ngModel)]="message.message" type="text">
    <button (click)="addMessage2(userProfile[0].key, friend.key)" type="button">Addmessage</button>
</div> -->





<div *ngIf="sendPrivateMessageOn" class="text-center searchContainer">
  <div class="mb-2 w-50">
    <input
      [(ngModel)]="searchWord"
      type="text"
      class="form-control"
      id="floatingInput"
      name="search"
      placeholder="Üzenet keresése"
    />
  </div>
</div>

<div class="row" *ngIf="!sendPrivateMessageOn">
  <div class="col">
    <!-- <div class="example-action-buttons">
      <button mat-button (click)="accordion.openAll()">Expand All</button>
      <button mat-button (click)="accordion.closeAll()">Collapse All</button>
    </div> -->
    <mat-accordion multi>
      <mat-expansion-panel class="mb-2">
        <mat-expansion-panel-header class="d-grid justify-content-center">
          <mat-panel-title>
            Ismerosok <mat-icon class="ms-2">groups</mat-icon></mat-panel-title
          >
        </mat-expansion-panel-header>

        <div class="row">
          <ng-container *ngFor="let user of userProfiles">
            <div *ngFor="let friend of userProfile[0].friends" class="col">
              <ng-container *ngIf="friend.friendId === user.uid">
                <mat-card class="mb-3">
                  <mat-card-header class="d-grid justify-content-center">
                    <mat-card-title>
                      {{ user.displayName }}
                    </mat-card-title>
                  </mat-card-header>
                  <mat-card-content class="d-flex justify-content-center"
                    ><img
                      [src]="user.profilePicture"
                      alt=""
                      width="50px"
                      height="50px"
                      class="rounded"
                  /></mat-card-content>
                  <mat-card-footer>
                    <mat-card-content class="d-grid justify-content-center">
                      <mat-card-subtitle >
                        {{ user.email }}
                      </mat-card-subtitle>
                      <div class="text-center"><button class="btn btn-sm btn-danger" type="button"><span (click)="removeFriend({key: friend['key']!})" class="icons text-center"><mat-icon>person_remove</mat-icon></span></button></div>
                    </mat-card-content>
                  </mat-card-footer>
                </mat-card>
              </ng-container>
            </div>
          </ng-container>
        </div>
      </mat-expansion-panel>
      <mat-expansion-panel>
        <mat-expansion-panel-header
          data-bs-toggle="modal"
          data-bs-target="#friendsModal"
          class="d-grid justify-content-center"
        >
          <mat-panel-title>
            Uzenetek <mat-icon class="ms-2">chat</mat-icon></mat-panel-title
          >
        </mat-expansion-panel-header>
        <div class="row">
          <div class="col" *ngFor="let user of userProfiles">
            <ng-container *ngFor="let friend of userFriends">
              <ng-container *ngIf="friend === user.uid">
                
                
                  <div class="card text-center mt-2 text-white bg-warning">
                    <h5 class="card-header">
                      <h2>{{ user.displayName }}</h2>
                    </h5>
                    <div class="card-body">
                      <img
                        [src]="user.profilePicture"
                        width="50px"
                        height="50px"
                        class="rounded-circle"
                      />
                      <!-- <h5 class="card-title">Special title treatment</h5> -->
                      <p class="card-text"></p>
                    </div>
                    <div class="card-footer">
                      <button
                        (click)="getMessageUser(user, '')"
                        mat-raised-button
                        *ngIf="friend === user.uid"
                        class="btn btn-sm btn-primary ms-2 blue"
                        type="button"
                      >
                        <span class="icons"
                          ><mat-icon>
                            {{ "chat" }}
                          </mat-icon></span
                        >
                      </button>
                    </div>
                  </div>
                
                
              </ng-container>
            </ng-container>
          </div>
        </div>
      </mat-expansion-panel>
    </mat-accordion>
  </div>
</div>

<div class="row" *ngIf="!sendPrivateMessageOn && friendsOn">
  <div *ngFor="let user of userProfiles" class="col-12 col-md-6 col-lg-3 mb-2">
    <ng-container *ngFor="let notFriend of userNotFriends">
      <ngb-toast
        *ngIf="notFriend.uid === user.uid && userProfile[0].uid !== user.uid"
        [id]="user.uid"
        class="d-grid justify-content-center text-center mt-2"
        [autohide]="false"
        [header]="user.displayName"
      >
        <img [src]="user.profilePicture" width="50px" height="50px" alt="" />
        <div>
          <small>{{ user.email }}</small>
        </div>
        <ng-container *ngFor="let notFriend of userNotFriends">
          <button
            *ngIf="notFriend.uid === user.uid"
            (click)="signAsFirstFriend(user)"
            mat-raised-button
            color="accent"
            type="button"
          >
            <span class="icons"
              ><mat-icon>
                {{ "person_add" }}
              </mat-icon></span
            >
          </button>
        </ng-container>
        <ng-container *ngFor="let friend of userFriends">
          <button
            *ngIf="friend === user.uid"
            (click)="getMessageUser(user, '')"
            class="btn btn-sm btn-primary ms-2"
            type="button"
          >
            <span class="icons"
              ><mat-icon>
                {{ user.uid === signedFriend.friendId ? "chat" : "chat" }}
              </mat-icon></span
            >
          </button>
          <button
            class="ms-2"
            *ngIf="friend === user.uid"
            [ngClass]="user.uid == friend ? 'green' : ''"
            (click)="signAsFirstFriend(user)"
            mat-raised-button
            color="accent"
            type="button"
          >
            <span class="icons"
              ><mat-icon>
                {{ "done" }}
              </mat-icon></span
            >
          </button>
        </ng-container>
        <h4
          class="fw-bold text-success mt-2"
          *ngIf="user.uid === signedFriend.friendId"
        >
          Ismerősök
        </h4>
      </ngb-toast>
    </ng-container>
  </div>
</div>

<div
  *ngIf="sendPrivateMessageOn"
  class="messageCardDiv d-grid justify-content-center"
>
  <button class="sendMessageOpenButton" *ngIf="!messageButtonClicked" (click)="messageButtonClicked = true"  mat-raised-button color="accent" type="button">Uzenet irasa</button>
  <mat-card *ngIf="messageButtonClicked" class="messageCard">
    <mat-card-header class="justify-content-center">
      <mat-card-title>
        <button
        (click)="backToUsers() ; messageButtonClicked = false"
        class="green ms-2 me-2 mb-2"
        type="button"
        mat-raised-button
      >
        <span class="icons">
          <mat-icon> keyboard_backspace </mat-icon>
        </span>
      </button>
        <mat-form-field class="messageInput">
          <mat-label>Üzenet írása</mat-label>
          <textarea  [(ngModel)]="message.message" matInput rows="2"></textarea>
        </mat-form-field>
      </mat-card-title>
    </mat-card-header>

    <mat-card-content class="text-center">
      <button *ngIf="message.message"
        class="me-2"
        color="accent"
        (click)="!editMessage ? addMessage() : updateMessage()"
        mat-raised-button
      >
        {{ !editMessage ? "Üzenet küldése" : "Uzenet Modositasa" }}
      </button>
      <button *ngIf="message.message"
        class="deleteButton"
        (click)="isSAdmin ? deleteMessages() : clearInput()"
        mat-raised-button
      >
        {{ isSAdmin ? "Üzenetek törlése" : "Mezö törlése" }}
      </button>

    </mat-card-content>
  </mat-card>
</div>

<div
  [ngClass]="
    message.senderId === user['userId']
      ? 'justify-content-start mainDivUser'
      : 'justify-content-end mainDivUsers'
  "
  class="d-grid mainDiv"
  *ngFor="
     let message of friendMessages | sort : message.timeStamp | filter : searchWord
  "
>
  <mat-card
    [ngClass]="_user.uid === user['userId'] ? 'left messagesCard' : 'right'"
    *ngFor="let _user of userProfiles"
    class="card"
  >
    <ng-container *ngIf="message.senderId === _user['uid']">
      <mat-card-header>
        <mat-card-title-group>
          <mat-card-title>
            <!-- <div class="d-flex justify-content-start align-items-center"> -->
            {{ _user.displayName }}

            <!-- </div> -->

            <!-- <div class="d-flex justify-content-end align-items-center"> -->
            <button
              [id]="message['key']"
              class="updateButton ms-2 mt-2"
              *ngIf="user.userId === message.uid"
              (click)="navigateToUpdateMessage(message)"
              type="button"
              mat-button
              color="accent"
            >
              Módosítás
            </button>
          </mat-card-title>
          <img
            #spanAnchor
            [id]="this.message['key']"
            mat-card-sm-image
            class="ms-2 overflow-auto"
            style="border-radius: 10px"
            [src]="_user.profilePicture"
            alt="Profilkép"
          />
          <!-- </div>  -->
        </mat-card-title-group>
      </mat-card-header>

      <div class="recipe-making-container">
        <mat-card-content>
          <b>{{ message.message }}</b>
        </mat-card-content>
        <mat-card-content class="card-content">
          <mat-card-subtitle> </mat-card-subtitle>
        </mat-card-content>
      </div>

      <mat-card-footer>
        <mat-card-content class="pad">
          <hr />

          <mat-card-title-group class="mat-card-title-group">
            <div class="emailDateDiv d-grid justify-content-start">
              <mat-card-subtitle
                [ngClass]="_user.uid === user['userId'] ? 'grey' : 'right'"
                >{{ message.email }}</mat-card-subtitle
              >
              <mat-card-subtitle
                [ngClass]="_user.uid === user['userId'] ? 'grey' : 'right'"
                >{{ message.date }}</mat-card-subtitle
              >
            </div>
          </mat-card-title-group>

          <div class="buttonCont">
            <mat-card-actions class="d-flex flex-wrap justify-content-end">
              <button
                class="me-2"
                [id]="message['key']"
                class="updateButton me-2"
                *ngIf="userProfile[0].uid === message.senderId"
                (click)="navigateToUpdateMessage(message)"
                mat-raised-button
                color="accent"
                type="button"
              >
                Módosítás
              </button>

              <span
                class="ms-2 mt-2 bi bi-trash3-fill h3 text-danger rounded"
                *ngIf="userProfile[0].uid === message.senderId"
                (click)="deleteMessage(message)"
              ></span>
            </mat-card-actions>
          </div>
        </mat-card-content>
      </mat-card-footer>
      <!-- <mat-card-actions class="justify-content-end">
                <button class="me-2"  routerLink="/recipes/edit" [queryParams]="{key: recipe.key}" mat-raised-button color="accent" type="button">Modositas</button>
                <button class="deleteButton"  (click)="deleteRecipe()" mat-raised-button type="button">Torles</button>
            </mat-card-actions>  -->
    </ng-container>
  </mat-card>
</div>
